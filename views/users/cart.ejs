<%- include('../partials/head.ejs') %>
<%- include('../partials/header.ejs') %>
<section>
    <div class="container">
        <table class="table mt-5">
            <thead>
                <tr>
                    <th scope="col">Items</th>

                    <th scope="col">Titles</th>
                    <th scope="col">Price</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Sub.total</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
                
                    <% if(cart){ %>
            <% cart.items.forEach((product)=>{ %>
                <tr>

                  
                        <td><img src="/public/uploads/<%=product.product_Id.images[0]%>" alt="" style="width: 50px;"></td>
                    <td><%=product.product_Id.name%></td>
                    <td><%=product.product_Id.price%></td>
                <!-- {{/each}} -->
                <td>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary" type="button" id="minus" onclick="minus('<%= product.product_Id._id%>','<%= product.product_Id.stock%>','<%= product.product_Id.name%>','<%= product.product_Id.price%>')">-</button>
                        <input type="number" name="quantity" class="form-control text-center mx-2"  value=<%= product.quantity %> style="width: 50px;" id="quantity_<%=product.product_Id._id%>"/>
                        <button class="btn btn-outline-secondary" type="button" id="plus" onclick="plus('<%= product.product_Id._id%>','<%= product.product_Id.stock%>','<%= product.product_Id.name%>','<%= product.product_Id.price%>')">+</button>
                      </div>
                </td>
                <td id="price_<%=product.product_Id._id%>"><%=product.price*product.quantity  %></td>
                <td>
                    <a href="" class="btn btn-danger" onclick="deleteCart('<%=product.product_Id._id%>')">Remove</a>
                </td>
                </tr>
                <% }) %>
                <!-- {{/each}} -->
                <%  } else{  %>
                    <tr>
                    <th >Cart is empty</th>
                </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</section>
<script>
    function deleteCart(id){
        Swal.fire({
        title: 'Are you sure?',
        text: "Do you want to delete the item?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No, cancel!'
    }).then((result)=>{
        if(result.Confirmed){
            fetch(`/deleteCart/${id}`,{
                method:"delete",
                headers:{
                    "Content-Type":"application/json"
                }
            }).then((res)=>{
                if(res.ok){
                    Swal.fire(
                        'Deleted!',
                        'Your item has been delted.',
                        'success'
                    ).then(()=>{
                        window.location.href='/cart-items'
                    })
                }
                else{
                    Swal.fire(
                        'Error!',
                        'There was a problem deleting the item.',
                        'error'

                    )
                }
            }).catch(err=>{
                console.log('Error',err)
                Swal.fire(
                    'Error!',
                    'There was a problem processing your request.',
                    'error'
                );

            })
        } else if (result.dismiss === Swal.DismissReason.cancel) {
            // User canceled the action
            Swal.fire(
                'Cancelled',
                'Your item delete was cancelled.',
                'error'
            ).then(() => {
                // Optionally redirect or do something else after cancel
                window.location.href = '/cart-items';
            });
        }
    });
       }
function updateCart(id,quantity,name,price){

    const product_Id=id
    fetch(`/updateCart/${product_Id}`,{
        method:'post',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({quantity:quantity,price})
    })
// .then((res)=>{
//         if(res.ok){
//             Swal.fire({
//     icon: 'success',
//     html: `<strong>You've changed</strong> <br><span style='font-weight: bold;'>${name}</span><br>QUANTITY to '${quantity}'`,
//     iconHtml: '<i class="fa fa-check-circle" style="color: #4CAF50;"></i>', 
//     showConfirmButton: false,
//     background: '#333',
//     color: '#fff', 
//     timer: 3000, 
//     customClass: {
//         popup: 'swal-custom-popup'
//     }
// });
//         }
//         else{
//             console.log("error")
//         }
//     })
.catch(err=>{
  console.error('Error:',err)
})
     
}

function plus(id,stock,name,price) {
  
    let quantity = parseInt(document.getElementById(`quantity_${id}`).value);

    console.log("helo")
    if(quantity<stock){
      quantity++;
      document.getElementById(`quantity_${id}`).value = quantity;
      tot_price=quantity*price
      document.getElementById(`price_${id}`).innerText=tot_price;
      updateCart(id,quantity,name,tot_price)
    
    }
   
}

function minus(id,stock,name,price) {
  
    let quantity = parseInt(document.getElementById(`quantity_${id}`).value);
   
    console.log('quantijdfkjsdbfkj',quantity,price);
    if(quantity>1){
      quantity--;
      document.getElementById(`quantity_${id}`).value = quantity;
      tot_price=quantity*price
      document.getElementById(`price_${id}`).innerText= tot_price;
     updateCart(id,quantity,name,tot_price)
    }
   
}
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Bootstrap JS (for navbar toggle) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Icons (optional) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</body>
</html>
