<%- include('../partials/head.ejs') %>
<%- include('../partials/header.ejs') %>
<section>
    <div class="container">
        <table class="table mt-5">
            <thead>
                <tr>
                    <th scope="col">Items</th>

                    <th scope="col">Titles</th>
                    <th scope="col">Price</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Sub.total</th>
                    <th scope="col">Action</th>
                </tr>
            </thead>
            <tbody>
  <!-- {{#each products}} -->
            <% cart.items.forEach((product)=>{ %>
                <tr>
<!-- {{#each this.product}} -->
                  
                        <td><img src="/public/uploads/<%=product.product_Id.images[0]%>" alt="" style="width: 50px;"></td>
                    <td><%=product.product_Id.name%></td>
                    <td><%=product.product_Id.price%></td>
                <!-- {{/each}} -->
                <td>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary" type="button" id="minus" onclick="minus('<%= product.product_Id._id%>','<%= product.product_Id.stock%>','<%= product.product_Id.name%>')">-</button>
                        <input type="number" name="quantity" class="form-control text-center mx-2"  value=<%= product.quantity %> style="width: 50px;" id="quantity_<%=product.product_Id%>">
                        <button class="btn btn-outline-secondary" type="button" id="plus" onclick="plus('<%= product.product_Id%>')">+</button>
                      </div>
                </td>
                <td id="price_<%=product.product_Id%>"><%=product.price  %></td>
                <td>
                    <a href="" class="btn btn-danger">Remove</a>
                </td>
                </tr>
                <% }) %>
                <!-- {{/each}} -->
            </tbody>
        </table>
    </div>
</section>
<script>
function updateCart(quantity,product){

    const product_Id=product._id
    fetch(`/updateCart/${product_Id}`,{
        method:'post',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({quantity:quantity})
    }).then((res)=>{
        if(res.ok){
            Swal.fire({
    icon: 'success',
    html: "<strong>You've changed</strong> <br><span style='font-weight: bold;'>${product.name}</span><br>QUANTITY to '${quantity}'",
    iconHtml: '<i class="fa fa-check-circle" style="color: #4CAF50;"></i>', 
    showConfirmButton: false,
    background: '#333',
    color: '#fff', 
    timer: 3000, 
    customClass: {
        popup: 'swal-custom-popup'
    }
});
        }
        else{
            console.log("error")
        }
    }).catch(err=>{
  console.error('Error:',err)
})
     
}

function plus(id,stock) {
  
    let quantity = parseInt(document.getElementById(`quantity_${product._id}`).value);
    console.log('dfashdfksa jahsg plus')
    if(quantity<product.stock){
      quantity++;
      document.getElementById(`quantity_${product._id}`).value = quantity;
      document.getElementById(`price_${product._id}`).innerText=quantity*product.price
      updateCart(quantity,product)
    
    }
   
}

function minus(product) {
    let quantity = parseInt(document.getElementById('quantity').value);
    console.log('quantijdfkjsdbfkj',quantity);
    if(quantity>1){
      quantity--;
      document.getElementById('quantity').value = quantity;
      document.getElementById('price').innerText=quantity*product.price
      console.log("idjfk")
      updateCart(quantity,product)
    }
   
}
</script>
<!-- Bootstrap JS (for navbar toggle) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Icons (optional) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</body>
</html>
