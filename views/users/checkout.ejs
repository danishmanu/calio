<%- include('../partials/head.ejs') %>
<%- include('../partials/header.ejs') %>
<style>
    .quantity-input {
        width: 50px; 
        height: 35px;
        border: 1px solid #ced4da;
        border-radius: 5px; 
        font-size: 16px;
    }

    .quantity-input:focus {
        outline: none; 
        box-shadow: none;
    }

    .btn-outline-secondary {
        padding: 0.375rem 0.75rem; 
        font-size: 1rem; 
    }
</style>


<div class="container-fluid w-100 bg-primary mt-5 ps-5 d-flex align-items-center" style="height: 10vh">
 
    <li class="breadcrumb-item" style="list-style: none;"><a href="#">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page" style="list-style: none; max-width: 500px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
        Checkout
    </li>
    
</div>
<div class="container">
    <div class="row">
        <div class="container col-md-6 rounded  mt-1 mb-2 py-0 ms-0 ">
            
          
            <div class="row d-flex justify-contern-center align-items-center">
                <div class="mt-4 "><h4 class="fw-bold fs-10">Select Delivery Address</h4></div>
                <% if(addresses && addresses.address.length!=0){%>
                <div class="mt-4 "><p class="fw-bold " style="font-size: 12px;" >DEFAULT ADDRESS</p></div>
              
                
                    
                    <div class="col-md-12 " id="address_<%=addresses.address[0]._id%>">
                       
                           <div class="address-card my-1">
                            
                               <div class="d-flex justify-content-between">
                                <div class="row p-0">
                                    <div class="p-0 ms-2 col">
                                       
                                          <div class="form-check">
                                            <input class="form-check-input" type="radio" value=<%=addresses.address[0]._id%> name="address" id="default_address" checked>
                                        </div>
                                    </div>
                                   <div class="p-0 m-0 col" >
                                       <p class="mb-1"><strong><%= addresses.address[0].name %></strong></p>
                                       <p class="mb-1"><%= addresses.address[0].address_line %></p>
                                       <p class="mb-1"><%= addresses.address[0].city %>,<%= addresses.address[0].state %> -<%= addresses.address[0].pincode %></p>
                                       <p class="mb-0">Mobile:<%=addresses.address[0].phone  %> </p>
                                   </div>
                                </div>
                                
                                   <div class="d-flex align-items-start ">
                                       <button onclick="editAddress('<%=addresses.address[0]._id%>')" class="icon-btn " title="Edit">
                                           <i class="fas fa-edit" style="margin-right: 12px;"></i>
                                       </button>
                                       <button onclick="deleteAddress('<%=addresses.address[0]._id%>')" class="icon-btn ml-4" title="Delete">
                                           <i class="fas fa-trash-alt"></i>
                                       </button>
                                   </div>
                               </div>
                           </div>
                       </div>
                       <% if(addresses.address.length>1){ %>
                       <div class="mt-4 "><p class="fw-bold " style="font-size: 12px;" >OTHER ADDRESS</p></div>
                       <% } %>
                <% addresses.address.forEach((address)=>{ %>
                    <% if(addresses.address[0]._id!=address._id){ %>
                        
             <div class="col-md-12 " id="address_<%=address._id%>">
                
                    <div class="address-card my-1">
                        <div class="d-flex justify-content-between">
                            <div class="row p-0">
                                <div class="p-0 ms-2 col"> <div class="form-check">
                                    <input class="form-check-input" type="radio" name="address" value=<%=address._id%> id="address_<%=address._id%>">
                                    
                                  </div>
                                </div>
                                <div class="p-0 m-0 col" >
                                <p class="mb-1"><strong><%= address.name %></strong></p>
                                <p class="mb-1"><%= address.address_line %></p>
                                <p class="mb-1"><%= address.city %>,<%= address.state %> -<%= address.pincode %></p>
                                <p class="mb-0">Mobile:<%=address.phone  %> </p>
                            </div>
                            </div>
                            <div class="d-flex align-items-start " onclick="">
                                <button onclick="editAddress('<%=address._id%>')" class="icon-btn " title="Edit">
                                    <i class="fas fa-edit" style="margin-right: 12px;"></i>
                                </button>
                                <button onclick="deleteAddress('<%=address._id%>')" class="icon-btn ml-4" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <% }})} %>

        
                <!-- Add New Address Button -->
                <div class="col-md-12 d-flex align-items-center">
                    <a href="/profile/addAddress?profile=false" class="primary">
                    <div class="add-new-address" style="padding-left: 100px; padding-right: 100px">
                        + Add New Address
                    </div>
                </a>
                </div>
            
            </div>
        </div>
        
        <div class="order-summary">
            <h5>Your Order</h5>
            <div class="product-list">
                <% cart.items.forEach((item,index)=>{ %>
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                     <img src="/public/uploads/<%= item.product_Id.images[0] %>" alt="" style="width: 60px;height: auto;margin-right: 10px;">
                    <p><%= item.product_Id.name %></p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex">
                            
                            <input type="number"  class="quantity-input text-center mx-2" value="<%= item.quantity %>" id="quantity_<%= item.product_Id._id %>" readonly>
                            
                        </div>
                    </div>
                    
                </div>
               
                <p>₹<%= item.product_Id.price %></p>
              </div>
             <% }) %>
            </div>
        
            <div class="totals">
              <div class="d-flex justify-content-between">
                <p>Subtotal</p>
                <p id="">₹ <span id="cart_total"><%=cart.total_price%></span></p>
              </div>
              <div class="d-flex justify-content-between">
                <p>Delivery</p>
                <p id="delivery">Free</p>
              </div>
              <div class="d-flex justify-content-between">
                <p>Coupon Discount</p>
                <p id="discount">₹ 0</p>
              </div>
              <hr>
              <div class="d-flex justify-content-between total-price">
                <p>Total</p>
                <p class="total" >₹ <span id="total"></span></p>
              </div>
            </div>
        
            <div class="payment-options mb-3">
              <p>Choose payment option</p>
              <div class="form-check">
                <input class="form-check-input"  type="radio" value="COD" name="paymentMethod" id="cashOnDelivery">
                <label class="form-check-label" for="cashOnDelivery">
                  Cash on delivery
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="paymentMethod" value="RAZORPAY" id="upi" required>
                <label class="form-check-label" for="upi">
                  UPI
                </label>
              </div>
            </div>
        
            <button class="place-order-btn" onclick="checkout()" type="button">Place Order</button>
          </div>
    </div>

</div>
    </div>
    </div>


</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    function changeTotal(checkbox,product_Id){
        if(checkbox.checked){
            document.getElementById("cart_total").innerText=checkbox.value
        }
        else{

        }
    }

    let cart_total=document.getElementById("cart_total").innerText.replace('₹', '').trim()
    let discount=document.getElementById("discount").innerText.replace('₹', '').trim()
    let delivery=document.getElementById("delivery").innerText
    if(delivery=="Free"){
        delivery=0
    }
    document.getElementById("total").innerText=(parseFloat(cart_total)+delivery-discount)
    document.addEventListener("DOMContentLoaded",()=>{
        const addressSaved=localStorage.getItem('addressSaved');
     
     if(addressSaved==="true"){
         Swal.fire({
             icon: 'success',
             title: 'Success',
             text: 'Your address has been successfully saved!',
         });
         localStorage.removeItem('addressSaved')
     }
    })
    async function checkout(){
        try {
              const addressElement  = document.querySelector('input[name="address"]:checked');
            const paymentMethodElement = document.querySelector('input[name="paymentMethod"]:checked');
            // const selectedProducts =document.querySelectorAll('input[name="product"]:checked')    
          
            if(!addressElement ){
                Swal.fire({
                    icon: 'warning', 
            title: 'Warning',
            text: 'please Select any Address to Continue..',
        })
        return
            }
        //     if(selectedProducts.length===0 ){
        //         Swal.fire({
        //             icon: 'warning', 
        //     title: 'Warning',
        //     text: 'Atleast Select one Product to continue',
        // })
        // return
        //     }

            if(!paymentMethodElement ){
                Swal.fire({
                    icon: 'warning', 
                    title: 'Warning',
            text: 'please Select any payment method to Continue',
        })
        return
            }
            const paymentMethod=paymentMethodElement.value;
            const address=addressElement.value;
            // let selectedProducts_id=[];
            // selectedProducts.forEach(product=>{
            //     selectedProducts_id.push(product.value)
            // })
            // console.log(selectedProducts_id)
            let data={
                address_Id:address,
                paymentMethod:paymentMethod,
                
            }
            let response=await fetch("/checkout",{
                method:"post",
                headers:{"Content-Type":"application/json"}
                ,body:JSON.stringify(data)

            })
            if(response.ok){
                const data=await response.json()
                if(data.cod==true){

                    Swal.fire({
                icon: 'success',
                title: 'Order Placed!',
                text: 'Your order has been successfully placed.',
            });
            window.location.href="/"
                }
                else if(data.razor==true){
                    let options={
                        key:data.key,
                        amount:data.amount,
                        currency:data.currency,
                        name:"calio",
                        description: "Test Transaction",
                        order_id: data.razorpayOrderId, 
                        handler:function (response) {
                     Swal.fire({
                     icon: 'success',
                     title: 'Payment Success!',
                     text: 'Your payment was successful!',
                      });
            window.location.href = "/";
          },
          "prefill": {
            "name": "Your Name",
            "email": "Your Email",
            "contact": "Your Phone Number"
          },  method: {
            netbanking: true,
            card: true,
            upi: true, 
            wallet: true,
        },
          "theme": {
            "color": "#C29958"
          }
        };
        let rzp=new Razorpay(options);
        rzp.open()
                    }

                }

        
                else{
                    Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something went wrong while placing the order.',
        })
                }
            
            
        } catch (error) {
            console.error('Error:', error) 
        }
        
    }
    async function deleteAddress(id){
        try{
            let response=await fetch(`/profile/deleteAddress/${id}`,{
            method:"DELETE"

        })
        if(response.ok){
          document.getElementById(`address_${id}`).remove()
            
        }
        else{
            throw new Error('something went wrong');
        }
        }catch(error){
            console.error('Error:', error) 
        }
       
    }
    function editAddress(id){
        fetch(`/profile/editAddress/${id}`,{
            method:"get",
            
           

        }).then((res)=>{
            if(res.ok){
           window.location.href=`/profile/editAddress/${id}?profile=false`
            }
            else{
                throw new Error('something went wrong');
            }

        }).catch(err=>{
            console.error('Error:', err) 
        })

    }
</script>
<%- include('../partials/footer.ejs') %>