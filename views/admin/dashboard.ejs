<%- include('../partials/admin-header.ejs') %>

<%- include('../partials/admin-sidebar.ejs') %>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<style>
  .card-custom {
    border-radius: 15px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .card-custom:hover {
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-5px);
  }

  .card-header-custom {
    
    color: white;
    text-align: center;
    border-radius: 15px 15px 0 0;
  }

  .card-body-custom {
    padding: 20px;
    text-align: center;
  }

  .icon-custom {
    font-size: 50px;
    color: #007bff;
    margin-bottom: 10px;
  }

  .btn-custom {
    background-color: #007bff;
    border: none;
    border-radius: 5px;
    transition: all 0.2s ease;
  }

  .btn-custom:hover {
    background-color: #0056b3;
  }
</style>
<div class="main-panel">
  <div class="content-wrapper">
    <div class="row">
      <div>
       
        <div>
          <p class="statistics-title">Sort by</p>
          <select class="form-select" id="sortBy" aria-label="Sort by">
            <option value="" <%= sort === '' ? 'selected' : '' %>>none</option>
            <option value="week" <%= sort === 'week' ? 'selected' : '' %>>Week</option>
            <option value="month" <%= sort === 'month' ? 'selected' : '' %>>Month</option>
            <option value="year" <%= sort === 'year' ? 'selected' : '' %>>Year</option>
            <option value="customDate" <%= sort === 'customDate' ? 'selected' : '' %>>customDate</option>
          </select>
        </div>
      </div>
    </div>

    <div class="row">
      <div class=" d-none" id="customDateDiv">
        <h6 class="text-dark mt-3">Sort By Custom Date</h6> 
        <div class="container">
         <div class="row ">
         <div class="mb-3 mr-4">
           <label for="name" class="form-label">Start date</label>
           <input type="date" id="startDate" class="form-control" onclick="" id="startDate" name="startDate" value="" required>
           <p id="startError" class="text-danger text-decoration-none"></p>
       </div>
       <div class="mb-3 ">
           <label for="name" class="form-label">End date</label>
           <input type="date" id="endDate"  class="form-control" id="endDate" name="endDate" value="" required>
          
       </div>
       <div class="d-flex align-items-center">
         <button id="applyCustomDate" class="btn btn-primary rounded rounded-3 py-4 mt-2 ml-3 align-items-center ">Apply</button>
       </div>
     

     </div>
        </div>
       </div>
      <div class="col-sm-12 mt-3">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

<div class="container">
<div class="row row-cols-1 row-cols-md-2 row-cols-xl-4">
       <div class="col">
		 <div class="card radius-10 border-start border-0 border-3 border-info">
			<div class="card-body">
				<div class="d-flex align-items-center">
					<div>
						<p class="mb-0 text-secondary">Total Orders</p>
						<h4 class="my-1 text-info">  <%= orders.length %></h4>
				
					</div>
					<div class="widgets-icons-2 rounded-circle bg-gradient-scooter text-white ms-auto"><i class="fa fa-shopping-cart"></i>
					</div>
				</div>
			</div>
		 </div>
	   </div>
	  
	  <div class="col">
		<div class="card radius-10 border-start border-0 border-3 border-success">
		   <div class="card-body">
			   <div class="d-flex align-items-center">
				   <div>
					   <p class="mb-0 text-secondary">Total Sales</p>
					   <h4 class="my-1 text-success"> ‚Çπ<%= totalAmount %></h4>
					   <!-- <p class="mb-0 font-13">-4.5% from last week</p> -->
				   </div>
				   <div class="widgets-icons-2 rounded-circle bg-gradient-ohhappiness text-white ms-auto"><i class="fa fa-bar-chart"></i>
				   </div>
			   </div>
		   </div>
		</div>
	  </div>
    <div class="col">
      <div class="card radius-10 border-start border-0 border-3 border-danger">
         <div class="card-body">
           <div class="d-flex align-items-center">
             <div>
               <p class="mb-0 text-secondary">Discount</p>
               <h4 class="my-1 text-danger">‚Çπ <%= totalDiscount.toFixed() %></h4>
               <!-- <p class="mb-0 font-13">+5.4% from last week</p> -->
             </div>
             <div class="widgets-icons-2 rounded-circle bg-gradient-bloody text-white ms-auto"><i class="fa fa-dollar"></i>
             </div>
           </div>
         </div>
      </div>
      </div>
	  <div class="col">
		<div class="card radius-10 border-start border-0 border-3 border-warning">
		   <div class="card-body">
			   <div class="d-flex align-items-center">
				   <div>
					   <p class="mb-0 text-secondary">Total Users</p>
					   <h4 class="my-1 text-warning">   <%= usersCount %></h4>
					  
				   </div>
				   <div class="widgets-icons-2 rounded-circle bg-gradient-blooker text-white ms-auto"><i class="fa fa-users"></i>
				   </div>
			   </div>
		   </div>
		</div>
	  </div> 
	</div>
</div>
<div class="container mt-5">
  <div class="row">
    
    <!-- Top Selling Products -->
    <div class="col-md-4">
      <div class="card card-custom">
        <div class="card-header card-header-custom bg-primary">
          <h5>Top Selling Products</h5>
        </div>
        <div class="card-body card-body-custom">
          <div class="icon-custom">üì¶</div>
          <p class="card-text">Discover our best-selling products that customers love the most!</p>
          <button id="showTopSellingProducts" class="btn btn-primary">View Products</button>
   
         
        </div>
      </div>
    </div>

    <!-- Top Selling Categories -->
    <div class="col-md-4">
      <div class="card card-custom">
        <div class="card-header card-header-custom bg-primary">
          <h5>Top Selling Categories</h5>
        </div>
        <div class="card-body card-body-custom">
          <div class="icon-custom">üìö</div>
          <p class="card-text">Explore the categories with the highest sales!</p>
          <button id="showTopSellingCategories" class="btn btn-primary">View Categories</button>
        </div>
      </div>
    </div>

   
    <div class="col-md-4">
      <div class="card card-custom">
        <div class="card-header card-header-custom bg-primary">
          <h5>Top Selling Brands</h5>
        </div>
        <div class="card-body card-body-custom">
          <div class="icon-custom">üè∑Ô∏è</div>
          <p class="card-text">Check out the brands that are leading in sales!</p>
          <button id="showTopSellingBrands" class="btn btn-primary">View Brands</button>
        </div>
      </div>
    </div>
    
  </div>
</div>
    

        <div class="row">
         
        
      
        
          <div class=" col-12  grid-margin stretch-card">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">Sales chart</h4>
                <canvas id="areaChart"></canvas>
              </div>
            </div>
          </div>
          
      
      </div>
        <div class="col-lg-12 grid-margin stretch-card">
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Order Id</th>
                      <th>Date</th>
                      <th>Total price</th>
                      <th>Payment Type</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% orders.forEach(order => { %>
                   
                        <tr>
                          <td><%=  order._id.toString().slice(-6) %></td>
                          <td><%= order.createdAt.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short', 
                            day: 'numeric',  
                        }); %></td>
                          <td>‚Çπ<%= order.payableAmount %></td>
                          <td><%= order.paymentMethod %></td>
                         
                            <td><%= order.paymentStatus==true ?"paid":"pending" %></td>
                          
                        </tr>
                     
                    <% }) %>
                  </tbody>
                </table>
               
                <button id="printButton" class="btn btn-primary text-white me-0 mt-3"><i class="icon-download"></i> Download Sales Report(PDF)</button>
                <button id="printExcelButton" class="btn btn-primary text-white me-0 mt-3"><i class="icon-download"></i> Download Sales Report(Excel)</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="topSellingProductsModal" tabindex="-1" role="dialog" aria-labelledby="topSellingProductsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="topSellingProductsModalLabel">Top Selling Products</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul id="topSellingProductsList" class="list-group">
         
          <% topSellingProducts.forEach(product => { %>
              <li class="list-group-item">
                  <strong><%= product.productName %></strong> <br>
                  Quantity Sold: <%= product.totalQuantity %> <br>
                  Total Sales:‚Çπ<%= product.totalSales %>
              </li>
          <% }) %>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="topSellingCategoriesModal" tabindex="-1" role="dialog" aria-labelledby="topSellingCategoriesModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="topSellingCategoriesModalLabel">Top Selling Categories</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul id="topSellingProductsList" class="list-group">
         
          <% topSellingCategories.forEach(cat => { %>
              <li class="list-group-item">
                  <strong><%= cat.categoryName %></strong> <br>
                  Quantity Sold: <%= cat.totalQuantity %> <br>
                  Total Sales: ‚Çπ<%= cat.totalSales %>
              </li>
          <% }) %>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="topSellingBrandsModal" tabindex="-1" role="dialog" aria-labelledby="topSellingBrandsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="topSellingBrandsModalLabel">Top Selling Products</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul id="topSellingProductsList" class="list-group">
         
          <% topSellingBrands.forEach(brand => { %>
              <li class="list-group-item">
                  <strong><%= brand.brandName %></strong> <br>
                  Quantity Sold: <%= brand.totalQuantity %> <br>
                  Total Sales: ‚Çπ<%= brand.totalSales %>
              </li>
          <% }) %>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script>
      document.getElementById('showTopSellingProducts').addEventListener('click', function() {
           
            $('#topSellingProductsModal').modal('show');
        });
        document.getElementById('showTopSellingCategories').addEventListener('click', function() {
           
           $('#topSellingCategoriesModal').modal('show');
       });
       document.getElementById('showTopSellingBrands').addEventListener('click', function() {
           
           $('#topSellingBrandsModal').modal('show');
       });
  const chartData = <%- JSON.stringify(data) %>; 
  
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('startError').innerText=""
    const printButton = document.getElementById('printButton');
    const printExcelButton = document.getElementById('printExcelButton');
    const sortBy = document.getElementById("sortBy");
    const applyCustomDate = document.getElementById("applyCustomDate");
    
    applyCustomDate.addEventListener('click', () => {
    const startDateValue = document.getElementById('startDate').value;
    const endDateValue = document.getElementById('endDate').value;

    
    if (!startDateValue || !endDateValue) {
        document.getElementById('startError').innerText = "Both start and end date should not be empty";
        return false;
    }

    const startDate = new Date(startDateValue);
    const endDate = new Date(endDateValue);

    console.log(startDate)
    console.log(endDate)
    if (endDate < startDate) {
        document.getElementById('startError').innerText = "Start date should be less than end date";
        return false;
    }
     let url = '/admin/dashboard?startDate='+startDate+'&endDate='+endDate;
       
       window.location.href = url;

    
    document.getElementById('startError').innerText = "";
});
  
    sortBy.addEventListener('change', () => {
        const selectedSort = sortBy.value;
        if(selectedSort=="customDate"){
          var now = new Date();
  var year = now.getFullYear();
  var month = String(now.getMonth() + 1).padStart(2, '0'); 
var day = String(now.getDate()).padStart(2, '0');


var formattedDate = `${year}-${month}-${day}`;


document.getElementById("startDate").max = formattedDate;
document.getElementById("endDate").max = formattedDate;
       
          $("#customDateDiv").removeClass('d-none').addClass('d-block');

        }
        else{
          let url = '/admin/dashboard?sort=' + selectedSort;
       
       window.location.href = url;
        }
       
    });
  
   

    printExcelButton.addEventListener('click', () => {
      const selectedSort = sortBy.value; 
    const url = new URL(window.location.href); 

    const startDate = url.searchParams.get("startDate");
    const endDate = url.searchParams.get("endDate");
    
    let pdfurl = '/admin/getExcelSales?'; 

    
    if (startDate && endDate) {
        pdfurl += 'startDate=' + startDate + '&endDate=' + endDate + '&';
    }

  
    pdfurl += 'sort=' + selectedSort;

    
    window.location.href = pdfurl; 
       
    });
    printButton.addEventListener('click', () => {
    const selectedSort = sortBy.value; 
    const url = new URL(window.location.href); 

    const startDate = url.searchParams.get("startDate");
    const endDate = url.searchParams.get("endDate");
    
    let pdfurl = '/admin/generate-pdf?'; 

    
    if (startDate && endDate) {
        pdfurl += 'startDate=' + startDate + '&endDate=' + endDate + '&';
    }

  
    pdfurl += 'sort=' + selectedSort;

    
    window.location.href = pdfurl; 
});

});
</script>

<%- include('../partials/admin-footer.ejs') %>